<!DOCTYPE html>
<html lang="en" data-theme="default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorsport News - GridView</title>
    <meta name="theme-color" content="#e10600">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Theme System -->
    <link rel="stylesheet" href="/themes/default.css" id="theme-css">
    <link rel="stylesheet" href="/themes/theme-system.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        racing: { red: '#e10600', orange: '#ff6b35', dark: '#0a0a0f', card: '#16161d', border: '#2a2a35', hover: '#1f1f28' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui'], mono: ['JetBrains Mono', 'monospace'] }
                }
            }
        }
    </script>
    <style>
        body { 
            background: var(--theme-gradient-body, linear-gradient(180deg, #0a0a0f 0%, #111117 100%)); 
            min-height: 100vh; 
            color: var(--theme-text-primary, #fff);
        }
        .category-btn { transition: all 0.2s ease; }
        .category-btn.active { background: #e10600; color: white; }
        .category-btn:not(.active):hover { background: rgba(255,255,255,0.1); }
        .news-card { transition: all 0.2s ease; }
        .news-card:hover { transform: translateY(-2px); border-color: rgba(225, 6, 0, 0.4); }
        .news-card:hover .news-image { transform: scale(1.02); }
        .news-image { transition: transform 0.3s ease; }
        .shimmer { background: linear-gradient(90deg, #16161d 0%, #2a2a35 50%, #16161d 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="text-white" style="color: var(--theme-text-primary);">
    <script src="/js/live-banner.js" defer></script>
    <!-- Nav Bar (matches index.html) -->
    <nav class="relative z-50 max-w-7xl mx-auto px-4 py-4 flex items-center justify-between border-b border-racing-border sticky top-0 backdrop-blur" style="border-color: var(--theme-border); background: var(--theme-bg-base, rgba(10,10,15,0.95));">
        <a href="/" class="flex items-center gap-2">
            <div class="w-8 h-8 rounded flex items-center justify-center gridview-logo-icon" style="background-color: var(--theme-primary, #e10600);">
                <span class="text-sm">üèÅ</span>
            </div>
            <span class="font-bold text-lg gridview-logo" style="color: var(--theme-text-primary);">GridView</span>
        </a>
        <!-- Mobile Hamburger -->
        <button onclick="toggleMobileMenu()" class="md:hidden flex flex-col gap-1.5 p-2" aria-label="Toggle menu">
            <span class="w-6 h-0.5 bg-current"></span>
            <span class="w-6 h-0.5 bg-current"></span>
            <span class="w-6 h-0.5 bg-current"></span>
        </button>
        <div class="hidden md:flex items-center gap-6">
            <a href="/" class="text-gray-400 hover:text-white text-sm transition-colors">Home</a>
            <a href="/results.html" class="text-gray-400 hover:text-white text-sm transition-colors">Results</a>
            <span class="text-sm font-medium" style="color: var(--theme-primary, #e10600);">News</span>
            <a href="/telemetry.html" class="text-gray-400 hover:text-white text-sm transition-colors">Telemetry</a>
            <button onclick="toggleSpoilerMode()" id="spoiler-toggle" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:border-racing-red/50 text-sm transition-all">
                <span id="spoiler-icon">üëÅÔ∏è</span>
                <span id="spoiler-text" class="text-gray-400">Spoilers</span>
            </button>
            <select id="timezone-picker" onchange="setTimezone(this.value)" class="bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-sm text-gray-400 cursor-pointer hover:border-racing-red/50 transition-colors">
                <option value="local">Local Time</option>
                <option value="UTC">UTC</option>
                <option value="America/New_York">ET</option>
                <option value="America/Los_Angeles">PT</option>
                <option value="Europe/London">GMT</option>
                <option value="Asia/Tokyo">JST</option>
            </select>
            <!-- Theme switcher injected by JS -->
            <button onclick="openNotificationSettings()" id="notification-btn" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:border-racing-red/50 text-sm transition-all">
                <span id="notification-icon">üîî</span>
                <span id="notification-text" class="text-gray-400">Alerts</span>
            </button>
        </div>
    </nav>
    
    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="fixed inset-0 z-50 hidden" style="background: var(--theme-bg-base, #0a0a0f);">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between px-4 py-4 border-b" style="border-color: var(--theme-border);">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded flex items-center justify-center" style="background-color: var(--theme-primary);">
                        <span class="text-sm">üèÅ</span>
                    </div>
                    <span class="font-bold text-lg" style="color: var(--theme-text-primary);">GridView</span>
                </div>
                <button onclick="toggleMobileMenu()" class="p-2 text-2xl" aria-label="Close menu">‚úï</button>
            </div>
            <div class="flex flex-col p-4 gap-2">
                <a href="/" class="flex items-center gap-3 px-4 py-3 rounded-lg text-lg font-medium hover:bg-white/5" style="color: var(--theme-text-primary);">üè† Home</a>
                <a href="/results.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-lg font-medium hover:bg-white/5" style="color: var(--theme-text-primary);">üèÜ Results</a>
                <a href="/news.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-lg font-medium bg-white/10" style="color: var(--theme-primary);">üì∞ News</a>
                <a href="/telemetry.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-lg font-medium hover:bg-white/5" style="color: var(--theme-text-primary);">üìä Telemetry</a>
            </div>
            <div class="flex flex-col p-4 gap-3 border-t mt-auto" style="border-color: var(--theme-border);">
                <button onclick="toggleSpoilerMode(); toggleMobileMenu();" class="flex items-center justify-between px-4 py-3 rounded-lg bg-white/5">
                    <span style="color: var(--theme-text-primary);">Spoiler Mode</span>
                    <span id="mobile-spoiler-icon">üëÅÔ∏è</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="max-w-6xl mx-auto px-4 py-8">
        <div class="flex items-center gap-4 mb-6">
            <span class="text-4xl">üì∞</span>
            <div>
                <h1 class="text-3xl font-bold">Motorsport News</h1>
                <p class="text-gray-400">Latest headlines from across the racing world</p>
            </div>
        </div>
        
        <!-- Category Filter -->
        <div id="category-filter" class="flex flex-wrap gap-2">
            <div class="shimmer h-9 w-24 rounded-lg"></div>
            <div class="shimmer h-9 w-20 rounded-lg"></div>
            <div class="shimmer h-9 w-16 rounded-lg"></div>
        </div>
    </header>

    <!-- News Grid -->
    <main class="max-w-6xl mx-auto px-4 pb-12">
        <div id="news-grid" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            <!-- Loading skeleton -->
            <div class="news-card bg-racing-card border border-racing-border rounded-xl overflow-hidden">
                <div class="shimmer h-48 w-full"></div>
                <div class="p-4 space-y-3">
                    <div class="shimmer h-6 w-3/4 rounded"></div>
                    <div class="shimmer h-4 w-full rounded"></div>
                    <div class="shimmer h-4 w-2/3 rounded"></div>
                </div>
            </div>
            <div class="news-card bg-racing-card border border-racing-border rounded-xl overflow-hidden">
                <div class="shimmer h-48 w-full"></div>
                <div class="p-4 space-y-3">
                    <div class="shimmer h-6 w-3/4 rounded"></div>
                    <div class="shimmer h-4 w-full rounded"></div>
                    <div class="shimmer h-4 w-2/3 rounded"></div>
                </div>
            </div>
            <div class="news-card bg-racing-card border border-racing-border rounded-xl overflow-hidden">
                <div class="shimmer h-48 w-full"></div>
                <div class="p-4 space-y-3">
                    <div class="shimmer h-6 w-3/4 rounded"></div>
                    <div class="shimmer h-4 w-full rounded"></div>
                    <div class="shimmer h-4 w-2/3 rounded"></div>
                </div>
            </div>
        </div>
        
        <!-- Load More -->
        <div id="load-more-container" class="mt-8 text-center hidden">
            <button onclick="loadMore()" id="load-more-btn" class="px-6 py-3 bg-racing-card border border-racing-border rounded-lg font-medium hover:bg-white/5 transition-colors">
                Load More
            </button>
        </div>
    </main>

    <!-- Footer attribution -->
    <footer class="max-w-6xl mx-auto px-4 py-6 border-t border-racing-border">
        <p class="text-gray-500 text-sm text-center">News powered by <a href="https://motorsport.com" target="_blank" class="text-gray-400 hover:text-white">Motorsport.com</a></p>
    </footer>

    <script>
        let currentCategory = 'all';
        let categories = {};
        let articleCount = 0;
        const ARTICLES_PER_PAGE = 12;

        function formatTimeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getCategoryColor(cat) {
            const colors = {
                'Formula 1': 'bg-red-500/20 text-red-400',
                'F1': 'bg-red-500/20 text-red-400',
                'WRC': 'bg-blue-500/20 text-blue-400',
                'MotoGP': 'bg-orange-500/20 text-orange-400',
                'IndyCar': 'bg-yellow-500/20 text-yellow-400',
                'NASCAR': 'bg-purple-500/20 text-purple-400',
                'NASCAR Cup': 'bg-purple-500/20 text-purple-400',
                'WEC': 'bg-green-500/20 text-green-400',
                'IMSA': 'bg-green-500/20 text-green-400',
            };
            return colors[cat] || 'bg-gray-500/20 text-gray-400';
        }

        async function init() {
            try {
                // Fetch categories
                const resp = await fetch('/api/news?categories=true');
                const data = await resp.json();
                categories = data.labels || {};
                
                renderCategoryFilter();
                loadNews();
            } catch (e) {
                console.error('Init error:', e);
                document.getElementById('news-grid').innerHTML = `
                    <div class="col-span-full text-center py-12 text-red-400">
                        Error loading news: ${e.message}
                    </div>
                `;
            }
        }

        function renderCategoryFilter() {
            const container = document.getElementById('category-filter');
            let html = '';
            
            for (const [key, label] of Object.entries(categories)) {
                html += `
                    <button 
                        onclick="switchCategory('${key}')" 
                        id="cat-${key}"
                        class="category-btn px-4 py-2 rounded-lg text-sm font-medium border border-racing-border ${key === currentCategory ? 'active' : 'text-gray-400'}"
                    >
                        ${label}
                    </button>
                `;
            }
            
            container.innerHTML = html;
        }

        function switchCategory(category) {
            if (category === currentCategory) return;
            
            // Update UI
            document.getElementById(`cat-${currentCategory}`)?.classList.remove('active');
            document.getElementById(`cat-${currentCategory}`)?.classList.add('text-gray-400');
            document.getElementById(`cat-${category}`)?.classList.add('active');
            document.getElementById(`cat-${category}`)?.classList.remove('text-gray-400');
            
            currentCategory = category;
            articleCount = 0;
            loadNews();
        }

        async function loadNews(append = false) {
            const grid = document.getElementById('news-grid');
            const loadMoreContainer = document.getElementById('load-more-container');
            
            if (!append) {
                grid.innerHTML = `
                    <div class="news-card bg-racing-card border border-racing-border rounded-xl overflow-hidden">
                        <div class="shimmer h-48 w-full"></div>
                        <div class="p-4 space-y-3">
                            <div class="shimmer h-6 w-3/4 rounded"></div>
                            <div class="shimmer h-4 w-full rounded"></div>
                        </div>
                    </div>
                `.repeat(6);
            }
            
            try {
                const resp = await fetch(`/api/news?category=${currentCategory}&limit=${ARTICLES_PER_PAGE}`);
                const data = await resp.json();
                
                if (!data.articles || data.articles.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-400">
                            No news found for this category
                        </div>
                    `;
                    loadMoreContainer.classList.add('hidden');
                    return;
                }
                
                renderNews(data.articles, append);
                articleCount = data.articles.length;
                
                // Show load more if we got full page
                if (data.articles.length >= ARTICLES_PER_PAGE) {
                    loadMoreContainer.classList.remove('hidden');
                } else {
                    loadMoreContainer.classList.add('hidden');
                }
                
            } catch (e) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-red-400">
                        Error loading news: ${e.message}
                    </div>
                `;
            }
        }

        function renderNews(articles, append = false) {
            const grid = document.getElementById('news-grid');
            
            let html = articles.map(article => {
                const primaryCategory = article.categories?.[0] || '';
                const categoryBadge = primaryCategory ? `
                    <span class="text-xs px-2 py-1 rounded ${getCategoryColor(primaryCategory)}">${primaryCategory}</span>
                ` : '';
                
                return `
                    <a href="${article.link}" target="_blank" rel="noopener" class="news-card bg-racing-card border border-racing-border rounded-xl overflow-hidden block">
                        ${article.image ? `
                            <div class="aspect-video overflow-hidden bg-racing-border">
                                <img src="${article.image}" alt="" class="news-image w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'h-full flex items-center justify-center text-4xl\\'>üèéÔ∏è</div>'">
                            </div>
                        ` : `
                            <div class="aspect-video bg-racing-border flex items-center justify-center text-4xl">üèéÔ∏è</div>
                        `}
                        <div class="p-4">
                            <div class="flex items-center gap-2 mb-2">
                                ${categoryBadge}
                                <span class="text-xs text-gray-500">${formatTimeAgo(article.published)}</span>
                            </div>
                            <h3 class="font-semibold text-lg leading-tight mb-2 line-clamp-2">${article.title}</h3>
                            <p class="text-sm text-gray-400 line-clamp-2">${article.description}</p>
                        </div>
                    </a>
                `;
            }).join('');
            
            if (append) {
                grid.innerHTML += html;
            } else {
                grid.innerHTML = html;
            }
        }

        function loadMore() {
            // For now, just scroll to top - RSS doesn't support pagination
            // In future could cache more items and paginate client-side
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize
        init();
    </script>
    
    <!-- Shared Header Functions -->
    <script>
        // Mobile Menu
        let mobileMenuOpen = false;
        function toggleMobileMenu() {
            mobileMenuOpen = !mobileMenuOpen;
            const menu = document.getElementById('mobile-menu');
            if (mobileMenuOpen) {
                menu.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                const mobileIcon = document.getElementById('mobile-spoiler-icon');
                if (mobileIcon) mobileIcon.textContent = spoilerMode ? 'üôà' : 'üëÅÔ∏è';
            } else {
                menu.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && mobileMenuOpen) toggleMobileMenu(); });
        
        // Spoiler Mode
        let spoilerMode = localStorage.getItem('gridview-spoiler-mode') === 'true';
        function toggleSpoilerMode() {
            spoilerMode = !spoilerMode;
            localStorage.setItem('gridview-spoiler-mode', spoilerMode);
            updateSpoilerUI();
        }
        function updateSpoilerUI() {
            const icon = document.getElementById('spoiler-icon');
            const text = document.getElementById('spoiler-text');
            if (icon) icon.textContent = spoilerMode ? 'üôà' : 'üëÅÔ∏è';
            if (text) text.textContent = spoilerMode ? 'Hidden' : 'Spoilers';
            document.body.classList.toggle('spoiler-mode', spoilerMode);
        }
        updateSpoilerUI();
        
        // Timezone
        function setTimezone(tz) {
            localStorage.setItem('gridview-timezone', tz);
        }
        const savedTz = localStorage.getItem('gridview-timezone');
        if (savedTz) {
            const picker = document.getElementById('timezone-picker');
            if (picker) picker.value = savedTz;
        }
        
        // Notifications placeholder
        function openNotificationSettings() {
            alert('Push notifications coming soon!');
        }
    </script>
    
    <!-- Theme Switcher -->
    <script src="/js/theme-switcher.js?v=4"></script>
    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>
